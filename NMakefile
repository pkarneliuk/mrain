PROGRAM = mrain

!IFDEF DEBUG
# Debug configuration
CPPFLAGS= /nologo /W4 /EHsc /TP /c /wd4201 /wd4995 /arch:SSE /Od /MTd /ZI /Fd"out\vc90.pdb"
DEFINES = /DWIN32 /D_CONSOLE /D_CRT_SECURE_NO_WARNINGS /D_DEBUG
LINKFLAGS=/DEBUG /PDB:"out\mrain.pdb" /MANIFEST:NO /NOLOGO /SUBSYSTEM:WINDOWS
!ELSE
# Release configuration
CPPFLAGS= /nologo /W4 /EHsc /TP /c /wd4201 /wd4995 /GL /arch:SSE /Ox /MT
DEFINES = /DWIN32 /D_CONSOLE /D_CRT_SECURE_NO_WARNINGS /DNDEBUG
LINKFLAGS=/LTCG:STATUS /MANIFEST:NO /NOLOGO /SUBSYSTEM:WINDOWS
!ENDIF

INCLUDES= /I "." /I ".\win"
LIBS    = kernel32.lib user32.lib opengl32.lib Gdi32.lib ole32.lib shell32.lib Strmiids.lib

PROJ_FILES  = *.cpp *.h Makefile devlog license nix win
PUBLIC_NAME = MatrixRain
PACK_NAME   = $(PROGRAM)-0.0.`date +%G%m%d`
DESTDIR     =

INSTALL_BIN_DIR = %SystemRoot%\system32\


.SUFFIXES : .cpp .obj .wxs .wixobj

all: out\$(PROGRAM).exe

clean:
    -rd /S /Q out
    -del mrain* *~

build-msi: out\$(PROGRAM).exe out\$(PROGRAM).msi

install: out\$(PROGRAM).exe
    copy /B out\$(PROGRAM).exe $(INSTALL_BIN_DIR)\$(PROGRAM).sCr

uninstall:
    del /Q /F $(INSTALL_BIN_DIR)\$(PROGRAM).sCr


# Build the Installer
out\$(PROGRAM).msi: out\installer.wixobj out\custom_ui.wixobj
    light.exe  -nologo -ext WixUIExtension -ext WiXUtilExtension -dWixUILicenseRtf=.\win\license.rtf -b out\ -pdbout out\installer.wixpdb -out $@ $**

{win}.wxs{out}.wixobj:
    candle.exe -nologo -ext WixUIExtension -ext WiXUtilExtension -out $@ $**


# Build the Program
out\$(PROGRAM).exe: $(OBJ) out\resources.res
	link.exe /OUT:$@ $(LINKFLAGS) $** $(LIBS)
!IFDEF PACK_UPX
	-upx.exe $@
!ELSEIFDEF PACK_FSG
	-fsg.exe $@
!ENDIF

{.}.cpp{out}.obj::
    @if not exist out mkdir out
    cl.exe $(CPPFLAGS) $(INCLUDES) $(DEFINES) -Fo"out/" $<

{win}.cpp{out}.obj::
    @if not exist out mkdir out
    cl.exe $(CPPFLAGS) $(INCLUDES) $(DEFINES) -Fo"out/" $<

out\resources.res: win\resources.rc
    @if not exist out mkdir out
    rc.exe /fo"$@" $**